version: "3.8"

services:
  obsidian-graph:
    build: .
    container_name: obsidian-graph-mcp
    stdin_open: true
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=obsidian_graph
      - POSTGRES_USER=obsidian
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY}
      - OBSIDIAN_VAULT_PATH=/vault
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      # Mount your Obsidian vault here (read-only for safety)
      - ${OBSIDIAN_VAULT_PATH:-./example-vault}:/vault:ro
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    restart: unless-stopped

  postgres:
    image: pgvector/pgvector:pg15
    container_name: obsidian-graph-postgres
    environment:
      - POSTGRES_DB=obsidian_graph
      - POSTGRES_USER=obsidian
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
    volumes:
      - obsidian-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U obsidian -d obsidian_graph"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

volumes:
  obsidian-postgres-data:
